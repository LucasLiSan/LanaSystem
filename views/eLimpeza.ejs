<%- include ('partials/header.ejs') %>
<%- include ('partials/nav.ejs') %>

            <section class="mainEstoqueLimpeza">
                <div class="title">
                    <h1>ESTOQUE DA LIMPEZA 
                        <i class="fas fa-shipping-fast" id="entradasEstoqueLimpeza"></i>
                        <i class="fas fa-clipboard-list" id="internoEstoqueLimpeza"></i>
                        <i class="fas fa-dolly-flatbed" id="saidasEstoqueLimpeza"></i>
                    </h1>
                    <i class="fas fa-columns" id="columnsIcon"></i>
                    <i class="far fa-list-alt" id="listIcon"></i>
                </div>
                <div class="containerEstoqueLimpeza">
                    <% for (let armarioLimpeza in prodsLimpezaOrganizados) { %>
                        <div class="armarios" id="armario<%= armarioLimpeza %>" tabindex="0">
                            <h3>ARMÁRIO <%= armarioLimpeza %></h3>
                            <% for (let prateleiraLimpeza in prodsLimpezaOrganizados[armarioLimpeza]) { %>
                                <div class="prateleiras" id="A<%= armarioLimpeza %>P<%= prateleiraLimpeza %>" tabindex="0">
                                    <h3>PRATELEIRA <%= prateleiraLimpeza %></h3>
                                    <% prodsLimpezaOrganizados[armarioLimpeza][prateleiraLimpeza].forEach(prodLimpeza => { %>
                                        <div class="cardItemEstoqueLimpeza">
                                            <div class="imgItem">
                                                <img src="imgs/imgsDefault/materialEscolar.webp" alt="material Escolar">
                                            </div>
                                            <div class="infosItem">
                                                <div class="row">
                                                    <label for="nomeItem">Item:</label>
                                                    <input type="text" name="nomeItem" value="<%= prodLimpeza.nomeProduto %>" disabled>
                                                </div>
                                                <div class="row rowAlt">
                                                    <div class="col">
                                                        <label for="corItem">Cor:</label>
                                                        <input type="text" name="corItem" value="<%= prodLimpeza.corProduto %>" disabled>
                                                    </div>
                                                    <div class="col">
                                                        <label for="qtdItem">Quantidade:</label>
                                                        <input type="text" name="qtdItem" value="<%= prodLimpeza.qtdEstoque %>" disabled>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <label for="validItem">Validade:</label>
                                                    <input type="text" name="validItem" value="<%= dataDeValidade(prodLimpeza.validadeProd) %>" disabled>
                                                </div>
                                            </div>
                                        </div>
                                    <% }); %>
                                </div>
                            <% } %>
                        </div>
                    <% } %>
                </div>
                <div class="listaGeralEstoqueLimpeza">
                    <div class="gridGeral">
                        <div class="gridHead">
                            <span>ID: </span>
                            <span>PRODUTO: </span>
                            <span>DESCRIÇÃO: </span>
                            <span>COR: </span>
                            <span>QUANTIDADE: </span>
                            <span>CATEGORIA: </span>
                            <span>CÓD. BARRAS: </span>
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <div class="gridBody">
                            <% prodsLimpeza.forEach(prodLimpeza => { %>
                                <div class="gridBodyRow">
                                    <span>#<%= prodLimpeza.idProduto %></span>
                                    <span><%= prodLimpeza.nomeProduto %></span>
                                    <span><%= prodLimpeza.descricaoProduto %></span>
                                    <span><%= prodLimpeza.corProduto %></span>
                                    <span><%= prodLimpeza.qtdEstoque %></span>
                                    <span><%= prodLimpeza.categoriaProdLimp?.categoria || 'N/A' %></span>
                                    <span><%= prodLimpeza.codBarraProd %></span>
                                    <span><a class="myModalBtn" data-id="<%= prodLimpeza.idProduto %>"><i class="fas fa-eye"></i></a></span>
                                    <span><a href="<%= prodLimpeza.idProduto %>"><i class="fas fa-pencil-alt"></i></a></span>
                                    <span><a href="<%= prodLimpeza.idProduto %>"><i class="fas fa-eraser"></i></i></a></span>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                    <!-- The Modal -->
                    <div id="myModal" class="modal">
                        <!-- Modal content -->
                        <div class="modal-content">
                            <div class="modal-header">
                                <span class="close">&times;</span>
                                <h2>INFORMAÇÕES DETALHADAS: <span id="modalProdutoTitle"></span></h2>
                            </div>
                            <div class="modal-body">
                                <p>ID: <span id="modalId"></span></p>
                                <p>Produto: <span id="modalProduto"></span></p>
                                <p>Descrição: <span id="modalDescricao"></span></p>
                                <p>Cor: <span id="modalCor"></span></p>
                                <p>Quantidade: <span id="modalQuantidade"></span></p>
                                <p>Categoria: <span id="modalCategoria"></span></p>
                                <p>Código de Barras: <span id="modalCodBarras"></span></p>
                                <p>Local: <span id="modalLocalArmario"></span></p>
                                <p>Armario: <span id="modalArmario"></span></p>
                                <p>Prateleira: <span id="modalPrateleira"></span></p>
                            </div>
                            <div class="modal-footer">
                                <span>- Sistema de gerenciamento da EMEB PINGO DE GENTE -</span>
                            </div>
                        </div>
                    </div>
                    <!-- Elemento oculto para armazenar o JSON -->
                    <div id="produtosData" style="display: none;">
                        <%- JSON.stringify(prodsLimpeza) %>
                    </div>
                </div>
                <div class="entradasEstoqueLimpeza">
                    <h4>CADASTRO
                        <i id="moreFormsLimpeza" class="fas fa-plus-circle"></i>
                    </h4>
                    <form class="formEntradasEstoqueLimpeza" action="/eLimpeza/add" method="POST" tabindex="0">
                        <div class="newFormLimpeza"></div>
                        <input type="submit" class="btnFormEntradasEstoqueLimpeza" value="CADASTRAR">
                    </form>
                </div>
                <div class="internoEstoqueLimpeza">
                    <h4>ORGANIZAÇÃO INTERNA</h4>
                    <form class="formInterno" action="/almoxarifado/edit" method="POST" tabindex="0">
                        <div class="bodyForm">
                            <div class="desorganizado">
                                <% for (let armarioLimpeza in prodsLimpezaOrganizados) { %>
                                    <% if (armarioLimpeza == 0) { %>
                                        <div class="armarios armarioForm" id="armario<%= armarioLimpeza %>" tabindex="0">
                                            <h3>RECEBIDOS</h3>
                                            <% for (let prateleiraLimpeza in prodsLimpezaOrganizados[armarioLimpeza]) { %>
                                                <div class="prateleiras" id="A<%= armarioLimpeza %>P<%= prateleiraLimpeza %>" tabindex="0">
                                                    <h3>A organizar</h3>
                                                    <% prodsLimpezaOrganizados[armarioLimpeza][prateleiraLimpeza].forEach(prodLimpeza => { %>
                                                        <div class="cardItemEstoqueLimpeza">
                                                            <div class="imgItem">
                                                                <img src="imgs/imgsDefault/materialEscolar.webp" alt="material Escolar">
                                                            </div>
                                                            <div class="infosItem">
                                                                <div class="row rowAlt">
                                                                    <div class="col">
                                                                        <label for="codBarraProd">Cód. Barra</label>
                                                                        <input type="text" name="codBarraProd" value="<%= prodLimpeza.codBarraProd %>" disabled>
                                                                    </div>
                                                                    <div class="col">
                                                                        <label for="nomeItem">Item:</label>
                                                                        <input type="text" name="idProdutoDesorg" value="<%= prodLimpeza.idProduto %>" hidden>
                                                                        <input type="text" name="nomeItem" value="<%= prodLimpeza.nomeProduto %>" disabled>
                                                                    </div>
                                                                </div>
                                                                <div class="row rowAlt">
                                                                    <div class="col">
                                                                        <label for="corItem">Cor:</label>
                                                                        <input type="text" name="corItem" value="<%= prodLimpeza.corProduto %>" disabled>
                                                                    </div>
                                                                    <div class="col">
                                                                        <label for="qtdItem">Quantidade:</label>
                                                                        <input type="text" id="qtdItemDesorganizado<%= prodLimpeza.idProduto %>" name="qtdItem" value="<%= prodLimpeza.qtdEstoque %>" disabled>
                                                                    </div>
                                                                </div>
                                                                <div class="row rowAlt">
                                                                    <div class="col">
                                                                        <label for="descricaoProduto">Descrição:</label>
                                                                        <input type="text" name="descricaoProduto" value="<%= prodLimpeza.descricaoProduto %>" disabled>
                                                                    </div>
                                                                    <div class="col">
                                                                        <label for="categoriaProd">Categoria:</label>
                                                                        <select name="categoriaProd" id="categoriaProd" disabled>
                                                                            <option value="1" <%= prodLimpeza.categoriaProd == 1 ? 'selected' : '' %>>Material de Limpeza</option>
                                                                            <option value="2" <%= prodLimpeza.categoriaProd == 2 ? 'selected' : '' %>>Produto de Limpeza</option>
                                                                            <option value="3" <%= prodLimpeza.categoriaProd == 3 ? 'selected' : '' %>>EPI</option>
                                                                            <option value="4" <%= prodLimpeza.categoriaProd == 4 ? 'selected' : '' %>>Produto de Higiêne</option>
                                                                            <option value="5" <%= prodLimpeza.categoriaProd == 5 ? 'selected' : '' %>>Material de Construção</option>
                                                                            <option value="6" <%= prodLimpeza.categoriaProd == 6 ? 'selected' : '' %>>Ferramentas</option>
                                                                            <option value="7" <%= prodLimpeza.categoriaProd == 7 ? 'selected' : '' %>>Material de Jardinagem</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    <% }); %>
                                                </div>
                                            <% } %>
                                        </div>
                                    <% } %>
                                <% } %>
                            </div>
                            <div class="organizar">
                                <div class="armarios armarioForm" tabindex="0">
                                    <h3>DESTINOS
                                        <i id="moreCards" class="fas fa-plus-circle"></i>
                                    </h3>
                                    <div class="prateleiras" tabindex="0">
                                        <h3>ORGANIZANDO</h3>
                                        <div class="newCard"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="submit" class="btnFormEntradasEstoqueLimpeza" value="CADASTRAR">
                    </form>
                </div>
                <div class="saidasEstoquesLimpeza"></div>
            </section>
            <script>
                // ---------- EFEITO DE FOCUS ---------- //
                document.querySelectorAll('.prateleiras').forEach(prateleira => {
                    prateleira.addEventListener('focus', function() {
                        this.classList.add('focused');
                        this.closest('.armarios').classList.add('focused');
                    });

                    prateleira.addEventListener('blur', function() {
                        this.classList.remove('focused');
                        this.closest('.armarios').classList.remove('focused');
                    });
                });
                // ---------- EFEITO DE FOCUS ---------- //

                // ---------- MOSTRAR ESCONDER DIVS ---------- //
                document.getElementById('columnsIcon').addEventListener('click', function() {
                    document.querySelector('.containerEstoqueLimpeza').style.display = 'flex';
                    document.querySelector('.listaGeralEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.entradasEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.internoEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.saidasEstoquesLimpeza').style.display = 'none';
                });

                document.getElementById('listIcon').addEventListener('click', function() {
                    document.querySelector('.containerEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.listaGeralEstoqueLimpeza').style.display = 'flex';
                    document.querySelector('.entradasEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.internoEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.saidasEstoquesLimpeza').style.display = 'none';
                });

                document.getElementById('entradasEstoqueLimpeza').addEventListener('click', function() {
                    document.querySelector('.containerEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.listaGeralEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.entradasEstoqueLimpeza').style.display = 'flex';
                    document.querySelector('.internoEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.saidasEstoquesLimpeza').style.display = 'none';
                });

                document.getElementById('internoEstoqueLimpeza').addEventListener('click', function() {
                    document.querySelector('.containerEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.listaGeralEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.entradasEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.internoEstoqueLimpeza').style.display = 'flex';
                    document.querySelector('.saidasEstoquesLimpeza').style.display = 'none';
                });

                document.getElementById('saidasEstoqueLimpeza').addEventListener('click', function() {
                    document.querySelector('.containerEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.listaGeralEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.entradasEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.internoEstoqueLimpeza').style.display = 'none';
                    document.querySelector('.saidasEstoquesLimpeza').style.display = 'flex';
                });
                // ---------- MOSTRAR ESCONDER DIVS ---------- //

                // ---------- CRIAÇÃO DE NOVOS CARDS COM ORGANIZAÇÃO CONFORME DISPONIBILIDADE ---------- //
                document.getElementById('moreCards').addEventListener('click', function() {
                    var newCard = document.createElement('div');
                    let classNum = document.querySelectorAll('.cardItemEstoqueLimpeza').length + 1;
                    newCard.className = `cardItemEstoqueLimpeza card${classNum}`;
                    newCard.innerHTML = `
                        <div class="imgItem">
                            <img src="imgs/imgsDefault/materialEscolar.webp" alt="material Escolar">
                        </div>
                        <div class="infosItem">
                            <div class="row rowAlt">
                                <div class="col">
                                    <label for="codBarraProdNew">Cód. Barra</label>
                                    <select class="codBarraProdSelect" name="codBarraProdNew">
                                        <option value="">SELECIONE</option>
                                        <% for (let armarioLimpeza in prodsLimpezaOrganizados) { %>
                                            <% if (armarioLimpeza == 0) { %>
                                                <% for (let prateleiraLimpeza in prodsLimpezaOrganizados[armarioLimpeza]) { %>
                                                    <% prodsLimpezaOrganizados[armarioLimpeza][prateleiraLimpeza].forEach(produto => { %>
                                                        <option value="<%= produto.codBarraProd %>"
                                                            data-id="<%= produto.idProduto %>"
                                                            data-nome="<%= produto.nomeProduto %>"
                                                            data-desc="<%= produto.descricaoProduto %>"
                                                            data-cat="<%= produto.categoriaProd %>"
                                                            data-cor="<%= produto.corProduto %>"
                                                            data-qtd="<%= produto.qtdEstoque %>">
                                                            <%= produto.codBarraProd %>
                                                        </option>
                                                    <% }); %>
                                                <% } %>
                                            <% } %>
                                        <% } %>
                                    </select>
                                </div>
                                <div class="col">
                                    <label for="nomeItemNew">Item:</label>
                                    <input type="text" class="nomeItem" name="nomeItemNew">
                                </div>
                                <div class="col">
                                    <i class="fas fa-minus-circle lessCard"></i>
                                </div>
                            </div>
                            <div class="row rowAlt">
                                <div class="col">
                                    <label for="corItemNew">Cor:</label>
                                    <input type="text" class="corItem" name="corItemNew">
                                </div>
                                <div class="col">
                                    <label for="qtdItemNew">Quantidade:</label>
                                    <input type="number" class="qtdItem" name="qtdItemNew" min="0">
                                </div>
                            </div>
                            <div class="row rowAlt">
                                <div class="col">
                                    <label for="descrProdNew">Descrição:</label>
                                <input type="text" class="descrProd" name="descrProdNew">
                                </div>
                                <div class="col">
                                    <label for="catProdNew">Categoria:</label>
                                    <select name="catProdNew" class="catProd">
                                        <option value="0">CATEGORIA</option>
                                        <option value="1">Material de Limpeza</option>
                                        <option value="2">Produto de Limpeza</option>
                                        <option value="3">EPI</option>
                                        <option value="4">Produto de Higiêne</option>
                                        <option value="5">Material de Construção</option>
                                        <option value="6">Ferramentas</option>
                                        <option value="7">Material de Jardinagem</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row rowAlt">
                                <div class="col">
                                    <label for="armarioDest">Armario:</label>
                                    <input type="text" name="armarioDest">
                                </div>
                                <div class="col">
                                    <label for="prateleiraDest">Prateleira:</label>
                                    <input type="text" name="prateleiraDest">
                                </div>
                            </div>
                        </div>
                    `;
                    document.querySelector('.newCard').appendChild(newCard);
                    attachEventListeners(newCard);
                    newCard.querySelector('.lessCard').addEventListener('click', function() {
                        newCard.remove();
                    });
                });

                function attachEventListeners(card) {
                    var codBarraSelect = card.querySelector('.codBarraProdSelect');
                    var qtdItemInput = card.querySelector('.qtdItem');

                    codBarraSelect.addEventListener('change', function() {
                        var selectedOption = this.options[this.selectedIndex];
                        var nomeProduto = selectedOption.getAttribute('data-nome');
                        var corProduto = selectedOption.getAttribute('data-cor');
                        var qtdEstoque = selectedOption.getAttribute('data-qtd');
                        var descProd = selectedOption.getAttribute('data-desc');
                        var catProd = selectedOption.getAttribute('data-cat');
                        var produtoId = selectedOption.getAttribute('data-id');

                        card.querySelector('.nomeItem').value = nomeProduto;
                        card.querySelector('.corItem').value = corProduto;
                        card.querySelector('.descrProd').value = descProd;
                        card.querySelector('.catProd').value = catProd;
                        qtdItemInput.value = qtdEstoque;
                        qtdItemInput.setAttribute('data-id', produtoId);
                        qtdItemInput.setAttribute('data-original-qtd', qtdEstoque);
                    });

                    qtdItemInput.addEventListener('input', function() {
                        var quantidadeOrganizar = parseInt(this.value);
                        var produtoId = this.getAttribute('data-id');
                        var qtdDesorganizadoElement = document.getElementById('qtdItemDesorganizado' + produtoId);
                        var qtdDesorganizado = parseInt(qtdDesorganizadoElement.value);
                        var originalQtd = parseInt(this.getAttribute('data-original-qtd'));

                        var totalDistribuido = 0;
                        document.querySelectorAll('.qtdItem[data-id="' + produtoId + '"]').forEach(function(input) { totalDistribuido += parseInt(input.value) || 0; });

                        if (totalDistribuido <= originalQtd) { qtdDesorganizadoElement.value = originalQtd - totalDistribuido; }
                        else {
                            alert('A quantidade total distribuída não pode ser maior que a quantidade disponível.');
                            this.value = originalQtd - (totalDistribuido - quantidadeOrganizar);
                            qtdDesorganizadoElement.value = 0;
                        }
                    });
                }
                document.querySelectorAll('.cardItemEstoqueLimpeza').forEach(attachEventListeners);
                // ---------- CRIAÇÃO DE NOVOS CARDS COM ORGANIZAÇÃO CONFORME DISPONIBILIDADE ---------- //
            </script>

<%- include ('partials/footer.ejs') %>